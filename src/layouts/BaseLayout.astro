---
import '@/styles/globals.css';
import { type Locale, getLocaleFromUrl, localeConfig } from '@/lib/i18n';
import SEO from '@/components/SEO.astro';

export interface Props {
  title?: string;
  description?: string;
  image?: string;
  locale?: Locale;
  noIndex?: boolean;
  structuredData?: Record<string, any>;
  keywords?: string[];
}

const {
  title,
  description,
  image,
  locale: propLocale,
  noIndex = false,
  structuredData,
  keywords,
} = Astro.props;

const currentUrl = Astro.url;
const locale = propLocale || getLocaleFromUrl(currentUrl);
const localeInfo = localeConfig[locale];

// Auto-detect staging environment and set noIndex
const isStaging = import.meta.env.NODE_ENV === 'staging' || 
                 currentUrl.hostname.includes('staging') ||
                 currentUrl.hostname.includes('dev') ||
                 currentUrl.hostname.includes('preview');
const shouldNoIndex = noIndex || isStaging;

// Default meta values
const defaultTitle = 'EuroTCG - European Trading Card Game Collection Manager';
const defaultDescription =
  'The ultimate platform for European TCG collectors. Scan, organize, and manage your trading card collections with advanced tools and GDPR compliance.';
const siteTitle = title ? `${title} | EuroTCG` : defaultTitle;
const siteDescription = description || defaultDescription;
const siteImage = image || '/images/og-default.jpg';

// Language and region
const htmlLang = locale;
const dir = localeInfo.dir;
---

<!doctype html>
<html lang={htmlLang} dir={dir} class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />

    <!-- Preload critical fonts -->
    <link rel="preload" href="/fonts/inter-var.woff2" as="font" type="font/woff2" crossorigin />

    <!-- DNS prefetch for external domains -->
    <link rel="dns-prefetch" href="//plausible.io" />

    <!-- Critical CSS inline - handled by Astro -->

    <!-- SEO Component -->
    <SEO
      title={siteTitle}
      description={siteDescription}
      image={siteImage}
      locale={locale}
      noIndex={shouldNoIndex}
      structuredData={structuredData}
      keywords={keywords}
    />

    <!-- Theme script (inline to prevent FOUC) -->
    <script is:inline>
      // Theme detection and application
      const getThemePreference = () => {
        if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
          return localStorage.getItem('theme');
        }
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      };

      const isDark = getThemePreference() === 'dark';
      document.documentElement.classList[isDark ? 'add' : 'remove']('dark');

      if (typeof localStorage !== 'undefined') {
        const observer = new MutationObserver(() => {
          const isDark = document.documentElement.classList.contains('dark');
          localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });
        observer.observe(document.documentElement, {
          attributes: true,
          attributeFilter: ['class'],
        });
      }
    </script>

    <!-- Reduced motion detection -->
    <script is:inline>
      const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)');
      if (prefersReducedMotion.matches) {
        document.documentElement.style.setProperty('--animation-duration', '0.01ms');
        document.documentElement.style.setProperty('--transition-duration', '0.01ms');
      }
    </script>

    <!-- GDPR-compliant Analytics (Plausible) -->
    <script is:inline defer data-domain="eurotcg.com" src="https://plausible.io/js/script.js"
    ></script>
  </head>

  <body class="bg-background text-foreground min-h-screen antialiased">
    <!-- Skip to content link for accessibility -->
    <a href="#main-content" class="skip-link"> Skip to main content </a>

    <!-- Main application structure -->
    <div id="app" class="flex min-h-screen flex-col">
      <!-- Header/Navigation would go here -->
      <header id="header" class="sticky top-0 z-50">
        <!-- Navigation component will be added -->
      </header>

      <!-- Main content area -->
      <main id="main-content" class="flex-1" role="main">
        <slot />
      </main>

      <!-- Footer would go here -->
      <footer id="footer">
        <!-- Footer component will be added -->
      </footer>
    </div>

    <!-- Background elements for visual interest -->
    <div class="pointer-events-none fixed inset-0 -z-10 overflow-hidden">
      <!-- Subtle gradient background -->
      <div class="from-primary/5 to-secondary/5 absolute inset-0 bg-gradient-to-br via-transparent">
      </div>

      <!-- Animated background elements (reduced motion friendly) -->
      <div
        class="bg-primary/10 animate-pulse-slow absolute left-1/4 top-1/4 h-64 w-64 rounded-full blur-3xl"
      >
      </div>
      <div
        class="bg-secondary/10 animate-pulse-slow absolute bottom-1/4 right-1/4 h-48 w-48 rounded-full blur-2xl"
        style="animation-delay: 1s;"
      >
      </div>
    </div>

    <!-- Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker
            .register('/sw.js')
            .then(registration => {
              console.log('SW registered: ', registration);
            })
            .catch(registrationError => {
              console.log('SW registration failed: ', registrationError);
            });
        });
      }
    </script>

    <!-- Error boundary for React components -->
    <script>
      window.addEventListener('error', event => {
        console.error('Global error:', event.error);
        // You could send this to an error reporting service
      });

      window.addEventListener('unhandledrejection', event => {
        console.error('Unhandled promise rejection:', event.reason);
        // You could send this to an error reporting service
      });
    </script>
  </body>
</html>

<style>
  /* Critical styles that need to be inline */
  html {
    color-scheme: light dark;
  }

  /* Ensure smooth scrolling is applied */
  @media (prefers-reduced-motion: no-preference) {
    html {
      scroll-behavior: smooth;
    }
  }

  /* Loading state styles */
  body:not(.loaded) * {
    animation-play-state: paused !important;
  }

  /* Focus management for better accessibility */
  .skip-link:focus {
    clip: auto !important;
    height: auto !important;
    width: auto !important;
    position: absolute !important;
    left: 6px !important;
    top: 7px !important;
    z-index: 999999 !important;
    padding: 8px 16px !important;
    text-decoration: none !important;
    background: hsl(var(--primary)) !important;
    color: hsl(var(--primary-foreground)) !important;
    border-radius: 4px !important;
  }
</style>
